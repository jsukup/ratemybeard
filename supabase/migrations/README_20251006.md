# Reports Table Schema Fix Migration

## Issue
The reports table had a schema mismatch causing 500 errors when users tried to flag inappropriate content:
- **Database columns**: `reason`, `description`
- **Application expects**: `report_reason`, `report_details`

## Solution
Migration `20251006_fix_reports_schema.sql` renames the columns to match application code.

## How to Apply This Migration

### Option 1: Via Supabase Dashboard (Recommended)
1. Go to https://supabase.com/dashboard/project/dimtnznykselivtdeicv
2. Navigate to **SQL Editor**
3. Copy and paste the contents of `20251006_fix_reports_schema.sql`
4. Click **Run** to execute the migration

### Option 2: Via Supabase CLI
```bash
# Navigate to project root
cd /root/ratemybeard

# Apply the migration
supabase db push

# Or apply specific migration file
psql $DATABASE_URL -f supabase/migrations/20251006_fix_reports_schema.sql
```

## Verification Steps

After applying the migration, verify it worked:

### 1. Check Schema
```sql
-- Run this in Supabase SQL Editor
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'reports'
ORDER BY ordinal_position;
```

Expected columns:
- `id` (uuid)
- `image_id` (uuid)
- `session_id` (text)
- `ip_address` (inet)
- `report_reason` (text) ✅
- `report_details` (text) ✅
- `status` (text)
- `created_at` (timestamp with time zone)
- `reviewed_at` (timestamp with time zone)
- `reviewed_by` (text)

### 2. Test Report Submission
1. Go to https://ratemybeard.com
2. Find an image on the leaderboard
3. Click the "Report" button
4. Select a report reason
5. Submit the report
6. **Expected**: Success message, no 500 error

### 3. Check Admin Dashboard
1. Go to https://ratemybeard.com/admin
2. Enter admin password
3. Verify flagged images appear correctly
4. **Expected**: Reports show with correct reason/details

## Rollback (If Needed)

If you need to rollback this migration:

```sql
-- Rename columns back to original names
ALTER TABLE reports
  RENAME COLUMN report_reason TO reason;

ALTER TABLE reports
  RENAME COLUMN report_details TO description;

-- Restore original CHECK constraint
ALTER TABLE reports
  DROP CONSTRAINT IF EXISTS reports_report_reason_check;

ALTER TABLE reports
  ADD CONSTRAINT reports_reason_check
  CHECK (reason IN ('not_beard', 'inappropriate', 'spam_fake', 'other'));
```

## Files Updated
1. `supabase/migrations/20251006_fix_reports_schema.sql` - New migration file
2. `ratemybeard-complete-migration.sql` - Updated documentation to reflect correct schema

## Related Files
- Application code: `web/app/api/reports/submit/route.ts`
- UI component: `web/components/ReportModal.tsx`
- Admin dashboard: `web/app/admin/page.tsx`
